name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3

    - name: Login no GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build da imagem Docker
      run: |
        docker build -t $REGISTRY/${IMAGE_NAME}:latest .

    - name: Push da imagem para o GHCR
      run: |
        docker push $REGISTRY/${IMAGE_NAME}:latest

    - name: Aplicar deploy no cluster Kubernetes
      uses: azure/k8s-deploy@v4
      with:
        manifests: |
          kubernetes/deployment.yaml
          kubernetes/service.yaml
          kubernetes/configmap.yaml
          kubernetes/hpa.yaml
        images: |
          ghcr.io/${{ github.repository }}:latest
        kubectl-version: "latest"
        namespace: default
        kubeconfig: ${{ secrets.KUBECONFIG }}
